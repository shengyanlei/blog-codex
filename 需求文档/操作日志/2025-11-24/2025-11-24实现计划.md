Codex Blog 后端代码审查与调整方案
目标说明
根据
后端技术设计文档
对现有后端代码进行全面审查，识别差异并进行必要的调整，确保代码实现与设计文档保持一致。

需要用户确认的事项
IMPORTANT

实现范围确认

设计文档中定义了许多当前尚未实现的功能：

RBAC 角色权限管理系统
文章版本控制与 diff 追踪
分类管理（Category）
OAuth2 第三方登录
MFA 多因素认证
工作流审批系统
部分服务模块仅有基础实现
建议方案： 优先实现核心数据模型和基础服务功能，高级功能（OAuth2、MFA、工作流等）作为后续迭代内容。

请确认是否按此方案进行？

拟议变更
组件 1：核心数据模型补充
[新增] Role.java - 角色实体
位置： backend/auth-service/src/main/java/com/codex/blog/auth/domain/Role.java

说明： 实现 RBAC 角色管理

角色名称、描述
创建时间、更新时间
与权限的多对多关系
[新增] Permission.java - 权限实体
位置： backend/auth-service/src/main/java/com/codex/blog/auth/domain/Permission.java

说明： 权限定义

资源标识（如 post:read, post:write）
权限描述
权限分组
[新增] UserRole.java - 用户角色关联
位置： backend/auth-service/src/main/java/com/codex/blog/auth/domain/UserRole.java

说明： 用户与角色的关联表

用户 ID
角色 ID
分配时间、分配人
[新增] RolePermission.java - 角色权限关联
位置： backend/auth-service/src/main/java/com/codex/blog/auth/domain/RolePermission.java

说明： 角色与权限的关联表

[修改] 
User.java
当前问题：

缺少用户昵称、头像等基础字段
缺少与角色的关联关系
调整内容：

添加 nickname 字段（昵称）
添加 avatar 字段（头像 URL）
添加 bio 字段（个人简介）
添加与 UserRole 的一对多关系
组件 2：内容管理增强
[新增] Category.java - 分类实体
位置： backend/content-service/src/main/java/com/codex/blog/content/domain/Category.java

说明： 文章分类管理

分类名称、slug、描述
支持层级结构（parent_id）
排序字段
[新增] PostCategory.java - 文章分类关联
位置： backend/content-service/src/main/java/com/codex/blog/content/domain/PostCategory.java

说明： 文章与分类的多对多关联

[新增] PostVersion.java - 文章版本
位置： backend/content-service/src/main/java/com/codex/blog/content/domain/PostVersion.java

说明： 文章版本控制

版本号
内容快照或 diff（gzipped JSON）
创建时间、创建人
版本说明
[修改] 
Post.java
当前问题：

缺少分类关联
缺少元数据字段（SEO、自定义数据）
缺少统计字段（浏览量等）
调整内容：

添加与 Category 的多对多关系
添加 metadata 字段（JSON 类型，存储 SEO 和自定义元数据）
添加 viewCount 字段（浏览量）
添加 likeCount 字段（点赞数）
添加 commentCount 字段（评论数）
组件 3：认证服务增强
[新增] RoleService.java - 角色管理服务
位置： backend/auth-service/src/main/java/com/codex/blog/auth/service/RoleService.java

功能：

创建、更新、删除角色
为角色分配权限
查询角色及其权限
[新增] RoleRepository.java, PermissionRepository.java
位置： backend/auth-service/src/main/java/com/codex/blog/auth/repository/

说明： 角色和权限的数据访问层

[新增] RoleController.java - 角色管理 API
位置： backend/auth-service/src/main/java/com/codex/blog/auth/web/RoleController.java

端点：

POST /api/v1/roles - 创建角色
PUT /api/v1/roles/{id} - 更新角色
DELETE /api/v1/roles/{id} - 删除角色
GET /api/v1/roles - 查询角色列表
POST /api/v1/roles/{id}/permissions - 分配权限
[修改] 
AuthService.java
调整内容：

添加权限检查方法 hasPermission(userId, resource, action)
在用户注册时分配默认角色
在登录响应中包含用户角色和权限信息
组件 4：内容服务增强
[新增] CategoryService.java - 分类管理服务
位置： backend/content-service/src/main/java/com/codex/blog/content/service/CategoryService.java

功能：

分类的 CRUD 操作
层级分类管理
分类树查询
[新增] CategoryRepository.java
位置： backend/content-service/src/main/java/com/codex/blog/content/repository/CategoryRepository.java

[新增] CategoryController.java
位置： backend/content-service/src/main/java/com/codex/blog/content/web/CategoryController.java

端点：

GET /api/v1/categories - 查询分类列表/树
POST /api/v1/categories - 创建分类
PUT /api/v1/categories/{id} - 更新分类
DELETE /api/v1/categories/{id} - 删除分类
[新增] PostVersionService.java - 版本管理服务
位置： backend/content-service/src/main/java/com/codex/blog/content/service/PostVersionService.java

功能：

保存文章版本
生成并存储 diff
版本回滚
版本对比
[新增] PostVersionRepository.java
位置： backend/content-service/src/main/java/com/codex/blog/content/repository/PostVersionRepository.java

[修改] 
PostService.java
调整内容：

在更新文章时自动保存版本
支持分类分配
支持定时发布（与调度器集成）
添加元数据管理
组件 5：其他服务验证与完善
Media Service（媒体服务）
检查项：

✓ 上传策略生成（签名 URL）
✓ S3 兼容存储集成
⚠ 图片处理队列（需要集成消息队列）
⚠ 防盗链机制
建议： 添加基于 token 的防盗链 URL 生成

Interaction Service（互动服务）
检查项：

✓ 评论基础功能
⚠ 评论楼层结构（Materialized Path）
⚠ 点赞/收藏功能
⚠ 垃圾评论过滤
建议： 完善评论树形结构和互动计数器（Redis）

Notification Service（通知服务）
检查项：

⚠ 事件驱动架构（消息队列集成）
⚠ 邮件发送
⚠ WebSocket/SSE 实时推送
⚠ 通知偏好管理
建议： 优先实现基础的站内通知和邮件通知

SEO Service（SEO 服务）
检查项：

⚠ Sitemap 生成
⚠ RSS Feed 生成
⚠ Meta/OG 标签管理
⚠ JSON-LD 结构化数据
建议： 实现 Sitemap 和 RSS 的定时生成任务

Analytics Service（分析服务）
检查项：

⚠ ClickHouse 集成
⚠ PV/UV 统计
⚠ 热门文章排行
⚠ 报表导出
建议： 先实现基于 Redis 的简单统计，后续再集成 ClickHouse

Admin Service（管理服务）
检查项：

⚠ 站点配置管理
⚠ 主题管理
⚠ 插件管理
⚠ 备份恢复
建议： 优先实现站点配置的 KV 存储和管理接口

Plugin Service（插件服务）
检查项：

⚠ Webhook 注册
⚠ API Token 管理
⚠ 插件沙箱
建议： 实现基础的 Webhook 和 API Token 功能

Gateway（网关/BFF）
检查项：

⚠ 接口聚合
⚠ 统一鉴权
⚠ 限流
⚠ GraphQL 支持（可选）
建议： 实现基础的路由转发和 JWT 鉴权，接口聚合作为后续优化

组件 6：构建配置
[修改] 
pom.xml
调整内容：

确认 Spring Boot 版本为 2.7.18（与设计文档一致）
添加 Lombok 依赖（简化实体类代码）
添加 springdoc-openapi 依赖（API 文档生成）
统一管理常用依赖版本
组件 7：数据库迁移
[新增] 数据库迁移脚本
工具： Flyway

位置： 各服务的 src/main/resources/db/migration/

内容：

V1__init_auth_tables.sql - 认证服务初始表
V2__add_role_permission.sql - 角色权限表
V1__init_content_tables.sql - 内容服务初始表
V2__add_category.sql - 分类表
V3__add_post_version.sql - 版本表
其他服务的初始化脚本
验证计划
自动化测试
构建验证

cd d:\需求开发\blog\blog-codex\backend
mvn clean install
单服务启动测试

# 启动认证服务
mvn -pl auth-service spring-boot:run
# 启动内容服务
mvn -pl content-service spring-boot:run
API 测试

测试认证端点（注册、登录、刷新 token）
测试文章 CRUD 操作
测试角色权限管理
验证 API 响应格式符合规范
手动验证
数据模型验证

检查数据库表是否正确创建
验证实体关系映射
测试级联操作
功能完整性

对照设计文档检查每个服务
验证所有必需端点已实现
检查 API 文档生成
集成测试

测试服务间通信
验证 JWT token 传递
测试错误处理和响应格式
验证事务一致性
实施优先级
P0 - 核心功能（本次实施）
✅ 补充核心数据模型（Role, Permission, Category, PostVersion）
✅ 完善 User 和 Post 实体
✅ 实现角色权限管理服务
✅ 实现分类管理服务
✅ 实现版本控制服务
✅ 添加数据库迁移脚本
✅ 构建验证
P1 - 基础服务完善（后续迭代）
完善各服务的基础功能
实现消息队列集成
实现缓存策略
实现基础的通知和邮件功能
P2 - 高级功能（未来规划）
OAuth2 第三方登录
MFA 多因素认证
工作流审批系统
ClickHouse 统计分析
GraphQL 支持
插件沙箱